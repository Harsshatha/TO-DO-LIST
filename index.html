<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Todo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /*
      ========================================
      CSS VARIABLES (THEME & LAYOUT)
      ========================================
    */
    :root {
      --bg-gradient: radial-gradient(at top left, #ffffff 0%, #f0f2f5 70%);
      --text: #1a2332;
      --muted: #555;
      --accent-gradient: linear-gradient(135deg, #8a2be2, #6200ea);
      --accent-solid: #761fe2;
      --card: #ffffff;
      --input: #f3f4f6;
      --input-border: #e5e7eb;
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.03);
      --shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --toast-bg: #1a2332;
      --toast-text: #ffffff;
    }

    .dark-mode {
      --bg-gradient: radial-gradient(at top left, #1a1a1e 0%, #111 70%);
      --text: #e6eef8;
      --muted: #94a3b8;
      --accent-gradient: linear-gradient(135deg, #a060fa, #7030c0);
      --accent-solid: #8a40e0;
      --card: #1c1c1e;
      --input: #2a2a2e;
      --input-border: #3a3a3e;
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
      --shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
      --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
      --toast-bg: #e6eef8;
      --toast-text: #1a2332;
    }

    /*
      ========================================
      BASE & LAYOUT
      ========================================
    */
    body {
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      background: var(--bg-gradient);
      color: var(--text);
      margin: 0;
      padding: 0 16px;
      min-height: 100vh;
      transition: background 0.5s, color 0.5s;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      font-synthesis: none;
      overflow-x: hidden;
    }

    #bg-canvas {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      z-index: 0;
      pointer-events: none;
      opacity: 0.3;
      filter: blur(20px);
      transition: opacity 0.5s, filter 0.5s;
    }

    .dark-mode #bg-canvas {
      opacity: 0.15;
      filter: blur(30px);
    }

    .container {
      max-width: 560px; /* Layout Change: Wider container */
      margin: 48px auto;
      background: var(--card);
      border-radius: 24px;
      box-shadow: var(--shadow);
      padding: 32px 24px 24px 24px;
      position: relative;
      z-index: 1;
      border: 1px solid var(--input);
      transition: background 0.5s, border-color 0.5s;
    }

    /*
      ========================================
      HEADER
      ========================================
    */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    header h1 {
      font-size: 1.75rem;
      font-weight: 700;
      margin: 0;
      color: var(--text);
      transition: color 0.5s;
    }

    #dark-toggle {
      background: var(--input);
      border: 1px solid var(--input-border);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(.4,2,.6,1);
      color: var(--accent-solid);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
      border-radius: 50%;
      width: 40px;
      height: 40px;
    }
    #dark-toggle:hover { 
      border-color: var(--accent-solid); 
      transform: scale(1.1) rotate(10deg);
    }
    #dark-toggle:active { transform: scale(0.9) rotate(15deg); }
    #dark-toggle svg { width: 1.3em; height: 1.3em; transition: transform 0.4s; }

    /*
      ========================================
      INPUTS, BUTTONS, FORMS
      ========================================
    */
    input[type="text"],
    input[type="date"],
    input[type="number"],
    select {
      flex: 1 1 180px;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid var(--input-border);
      background: var(--input);
      color: var(--text);
      font-size: 1rem;
      font-family: 'Inter', sans-serif;
      transition: background 0.3s, color 0.3s, border-color 0.3s, box-shadow 0.3s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--accent-solid);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-solid) 20%, transparent);
    }

    button {
      background: var(--accent-gradient);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      padding: 12px 16px;
      border-radius: 10px;
      transition: transform 0.2s cubic-bezier(.4,2,.6,1), box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px color-mix(in srgb, var(--accent-solid) 30%, transparent);
    }

    button:active {
      transform: scale(0.96);
      filter: brightness(0.95);
      box-shadow: none;
    }
    
    button.icon-btn {
      background: var(--input);
      color: var(--muted);
      border: 1px solid var(--input-border);
      padding: 8px;
      width: 38px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
    }
    button.icon-btn:hover {
      color: var(--accent-solid);
      border-color: var(--accent-solid);
      transform: scale(1.05);
      box-shadow: none;
    }
    button.icon-btn svg { width: 18px; height: 18px; }

    /*
      ========================================
      TASK ADD FORM (NEW)
      ========================================
    */
    #task-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 24px;
      transition: all 0.4s ease;
    }
    
    .task-form-main {
      display: flex;
      gap: 12px;
    }
    
    #task-text {
      flex: 1;
    }
    
    #add-task-btn {
      flex-shrink: 0;
      width: 46px;
      height: 46px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Animation Change: Bouncy spring transition */
    .task-form-secondary,
    .task-form-extra {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: max-height 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55), 
                  opacity 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55),
                  margin-top 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }
    
    #task-form.expanded .task-form-secondary {
      max-height: 200px; /* Adjust as needed */
      opacity: 1;
      margin-top: 4px;
    }

    #task-form.extra-expanded .task-form-extra {
      max-height: 300px; /* Adjust as needed */
      opacity: 1;
      margin-top: 4px;
    }
    
    #more-options-btn {
      background: var(--input);
      color: var(--text);
      border: 1px solid var(--input-border);
      font-weight: 500;
      grid-column: 1 / -1; /* Span full width */
    }
    #more-options-btn:hover {
      border-color: var(--muted);
      transform: none;
      box-shadow: none;
    }

    /*
      ========================================
      TASK LIST
      ========================================
    */
    #task-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .task {
      display: flex;
      flex-direction: column;
      padding: 14px 16px;
      border-radius: 12px;
      background: var(--card);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--input);
      opacity: 0;
      transform: translateY(20px);
      /* Animation Change: Staggered animation will be applied by JS */
      animation: fadeInSlide 0.7s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
      /* Animation Change: Bouncier hover */
      transition: transform 0.3s cubic-bezier(.4,2,.6,1), box-shadow 0.2s ease-out, background 0.3s;
    }
    .task:hover { 
      transform: translateY(-4px); /* Bouncier hover */
      box-shadow: var(--shadow); 
    }

    .task-content {
      display: flex;
      align-items: center; /* Aligns checkbox/text with buttons */
      justify-content: space-between;
      gap: 12px;
    }

    /* Layout Change: Cleaner task structure */
    .task .left { 
      display: flex; 
      flex-direction: column;
      align-items: flex-start; 
      gap: 0px; /* Gap handled by tags margin */
      flex: 1;
      min-width: 0; /* Prevents long text from overflowing */
    }
    
    .task .left p { 
      margin: 0; 
      font-weight: 500;
      font-size: 1.05rem;
      flex: 1;
      /* Text can wrap if needed */
    }
    
    /* Layout Change: Aligns checkbox and text */
    .task-main-line {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
    }
    
    /* Layout Change: Tags on new line */
    .task-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      flex-shrink: 0;
      padding-left: 32px; /* Aligns with text (checkbox width + gap) */
      margin-top: 10px;
    }
    
    .task-tag {
      font-size: 11px;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 6px;
      background: var(--input);
      color: var(--muted);
      white-space: nowrap;
    }
    .task-tag.priority-low { background: #dbeafe; color: #1d4ed8; }
    .task-tag.priority-high { background: #fee2e2; color: #b91c1c; }
    .dark-mode .task-tag.priority-low { background: #1e3a8a; color: #bfdbfe; }
    .dark-mode .task-tag.priority-high { background: #7f1d1d; color: #fecaca; }


    .task .right { display: flex; align-items: center; gap: 8px; }

    .task.completed .left p {
      text-decoration: line-through;
      color: var(--muted);
    }
    .task.completed { 
      background: var(--input); 
      opacity: 0.7;
    }
    
    /* Custom Checkbox */
    input[type="checkbox"] {
      appearance: none;
      -webkit-appearance: none;
      background: var(--input);
      border: 1px solid var(--input-border);
      width: 20px;
      height: 20px;
      border-radius: 6px;
      cursor: pointer;
      position: relative;
      flex-shrink: 0;
      transition: all 0.2s ease;
    }
    input[type="checkbox"]:hover {
      border-color: var(--accent-solid);
    }
    input[type="checkbox"]:checked {
      background: var(--accent-solid);
      border-color: var(--accent-solid);
    }
    input[type="checkbox"]:checked::before {
      content: 'âœ”';
      color: white;
      font-size: 14px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    /*
      ========================================
      IN-PLACE EDIT FORM (NEW)
      ========================================
    */
    .task-edit-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      /* Animation Change: Bouncy spring transition */
      transition: max-height 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55), 
                  opacity 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55),
                  padding-top 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }
    
    .task.is-editing .task-edit-form {
      max-height: 500px; /* Adjust as needed */
      opacity: 1;
      padding-top: 16px;
    }
    
    /* Hide normal content when editing */
    .task.is-editing .task-content {
      display: none;
    }
    
    .task-edit-form .full-width {
      grid-column: 1 / -1;
    }
    
    .edit-actions {
      grid-column: 1 / -1;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    
    .edit-actions button[type="button"] {
      background: var(--input);
      color: var(--text);
      border: 1px solid var(--input-border);
      font-weight: 500;
    }
    .edit-actions button[type="button"]:hover {
      border-color: var(--muted);
      transform: none;
      box-shadow: none;
    }

    /*
      ========================================
      MODAL & TOAST
      ========================================
    */
    .small { font-size: 12px; color: var(--muted); transition: color 0.5s; }
    
    #toast {
      position: fixed;
      left: 50%;
      bottom: 32px;
      transform: translateX(-50%) translateY(10px);
      min-width: 120px;
      max-width: 90vw;
      background: var(--toast-bg);
      color: var(--toast-text);
      padding: 14px 24px;
      border-radius: 10px;
      box-shadow: var(--shadow-lg);
      opacity: 0;
      pointer-events: none;
      font-size: 1em;
      font-weight: 500;
      text-align: center;
      z-index: 2000;
      transition: opacity 0.4s, bottom 0.4s, transform 0.4s;
    }
    
    #toast.show { opacity: 1; bottom: 48px; pointer-events: auto; transform: translateX(-50%) translateY(0); }
    
    #login-modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(5px);
      z-index: 1000;
      transition: opacity 0.5s, backdrop-filter 0.5s;
    }
    
    #login-form {
      background: var(--card);
      padding: 32px 24px;
      border-radius: 18px;
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-direction: column;
      gap: 16px;
      min-width: 280px;
      transition: all 0.4s;
      transform: scale(1);
    }
    
    #login-form h2 { margin: 0 0 8px 0; font-weight: 700; }
    
    .modal-fade-in { animation: modalFadeIn 0.5s cubic-bezier(.4,2,.6,1); }
    .modal-fade-out { animation: modalFadeOut 0.4s ease-out forwards; }
    @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    @keyframes modalFadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
    
    /* Keyframe for initial task load */
    @keyframes fadeInSlide { 
      from { 
        opacity: 0; 
        transform: translateY(20px) scale(0.95);
      }
      to { 
        opacity: 1; 
        transform: translateY(0) scale(1);
      } 
    }

  </style>
</head>
<body>
  
  <!-- Animated Background -->
  <canvas id="bg-canvas"></canvas>
  
  <!-- Toast Notification -->
  <div id="toast"></div>

  <!-- Login Modal -->
  <div id="login-modal" class="modal-fade-in">
    <form id="login-form">
      <h2>Smart Login</h2>
      <input id="login-username" type="text" placeholder="Username" required />
      <input id="login-password" type="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
  </div>

  <!-- Main App Content -->
  <div id="app-content" style="display:none;">
    <div class="container">
      <header>
        <h1>Smart Todo</h1>
        <button id="dark-toggle" aria-pressed="false" aria-label="Toggle Dark Mode">
          <span id="dark-icon"></span>
        </button>
      </header>
      
      <main>
        <!-- REDESIGNED ADD TASK FORM -->
        <form id="task-form">
          <!-- Main, always visible part -->
          <div class="task-form-main">
            <input id="task-text" type="text" placeholder="Add a new task..." required />
            <button type="submit" id="add-task-btn" aria-label="Add Task">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </button>
          </div>
          
          <!-- Secondary, expandable part -->
          <div class="task-form-secondary">
            <select id="task-category">
              <option value="General">General</option>
              <option value="Work">Work</option>
              <option value="Study">Study</option>
              <option value="Personal">Personal</option>
            </select>
            <input id="task-due" type="date" title="Due Date" />
            <button type="button" id="more-options-btn">More Options</button>
          </div>
          
          <!-- Tertiary, hidden part -->
          <div class="task-form-extra">
            <input id="task-priority" type="number" min="1" max="5" placeholder="Priority (1-5)" />
            <input id="task-location" type="text" placeholder="Location" />
            <input id="task-notes" class="full-width" type="text" placeholder="Notes" />
            <input id="task-tags" class="full-width" type="text" placeholder="Tags (comma separated)" />
          </div>
        </form>
        
        <ul id="task-list"></ul>
      </main>
    </div>
  </div>

  <script>
    // ========================================
    // WAIT FOR DOM
    // ========================================
    document.addEventListener('DOMContentLoaded', () => {

      // ========================================
      // GLOBAL ELEMENTS
      // ========================================
      const API = 'http://localhost:5000'; // Keep original API
      const taskForm = document.getElementById('task-form');
      const taskList = document.getElementById('task-list');
      const darkToggle = document.getElementById('dark-toggle');
      const darkIcon = document.getElementById('dark-icon');

      // ========================================
      // ANIMATED BACKGROUND
      // ========================================
      const canvas = document.getElementById('bg-canvas');
      const ctx = canvas.getContext('2d');
      let width = window.innerWidth, height = window.innerHeight;
      function resizeCanvas() {
        width = window.innerWidth; height = window.innerHeight;
        canvas.width = width; canvas.height = height;
      }
      window.addEventListener('resize', resizeCanvas);
      resizeCanvas();
      
      const blobs = Array.from({length: 7}, (_,i) => ({
        x: Math.random()*width, y: Math.random()*height,
        r: 120+Math.random()*80, a: Math.random()*Math.PI*2,
        s: 0.5+Math.random()*0.7, c: `hsl(${200+Math.random()*100},80%,${40+Math.random()*30}%)`
      }));
      
      function drawBg() {
        ctx.clearRect(0,0,width,height);
        ctx.globalAlpha = 0.7;
        for(const b of blobs) {
          ctx.beginPath();
          ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
          ctx.fillStyle = b.c;
          ctx.shadowColor = b.c;
          ctx.shadowBlur = 80;
          ctx.fill();
        }
        ctx.globalAlpha = 1;
      }
      
      function animateBg() {
        for(const b of blobs) {
          b.x += Math.cos(b.a)*b.s;
          b.y += Math.sin(b.a)*b.s;
          b.a += (Math.random()-0.5)*0.01;
          if(b.x<0) b.x=width; if(b.x>width) b.x=0;
          if(b.y<0) b.y=height; if(b.y>height) b.y=0;
        }
        drawBg();
        requestAnimationFrame(animateBg);
      }
      animateBg();

      // ========================================
      // TOAST NOTIFICATION
      // ========================================
      function showToast(msg, duration = 2500) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), duration);
      }
      
      // ========================================
      // HTML ESCAPING
      // ========================================
      function escapeHtml(s){
        if(!s) return '';
        return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
      }

      // ========================================
      // API CALLS
      // ========================================
      async function fetchTasks() {
        try {
          const res = await fetch(`${API}/tasks`);
          if (!res.ok) throw new Error('Failed to fetch tasks');
          const tasks = await res.json();
          renderTasks(tasks);
        } catch (e) {
          console.error(e);
          showToast('Error: Could not load tasks.', 3000);
        }
      }

      async function toggleComplete(id, isCompleted) {
        try {
          await fetch(`${API}/tasks/${id}`, { 
            method: 'PUT', 
            headers: {'Content-Type':'application/json'}, 
            body: JSON.stringify({ isCompleted }) 
          });
          // Optimistic update
          const taskEl = document.querySelector(`li[data-id="${id}"]`);
          if (taskEl) {
            taskEl.classList.toggle('completed', isCompleted);
            taskEl.querySelector('input[type="checkbox"]').checked = isCompleted;
          }
        } catch (e) {
          console.error(e);
          showToast('Error: Could not update task.', 3000);
          fetchTasks(); // Re-sync
        }
      }

      async function deleteTask(id) {
        try {
          await fetch(`${API}/tasks/${id}`, { method: 'DELETE' });
          // Optimistic update
          const taskEl = document.querySelector(`li[data-id="${id}"]`);
          if (taskEl) {
            taskEl.style.animation = 'modalFadeOut 0.4s ease-out forwards';
            setTimeout(() => taskEl.remove(), 400);
          }
        } catch (e) {
          console.error(e);
          showToast('Error: Could not delete task.', 3000);
        }
      }

      async function updateTask(id, changes) {
        try {
          await fetch(`${API}/tasks/${id}`, { 
            method: 'PUT', 
            headers: {'Content-Type':'application/json'}, 
            body: JSON.stringify(changes) 
          });
          fetchTasks(); // Full re-render to show changes
          showToast('Task updated!', 1800);
        } catch (e) {
          console.error(e);
          showToast('Error: Could not update task.', 3000);
        }
      }

      // ========================================
      // TASK RENDERING (REDESIGNED)
      // ========================================
      function renderTasks(tasks) {
        taskList.innerHTML = '';
        tasks.forEach((t, index) => {
          const li = document.createElement('li');
          li.className = 'task' + (t.isCompleted ? ' completed' : '');
          li.dataset.id = t._id;
          // Animation Change: Staggered animation delay
          li.style.animationDelay = `${index * 60}ms`; 
          
          // --- Helper: Create tags ---
          let tagsHtml = '';
          if (t.category) {
            tagsHtml += `<span class="task-tag">${escapeHtml(t.category)}</span>`;
          }
          if (t.priority) {
            const prioClass = t.priority >= 4 ? 'priority-high' : (t.priority <= 2 ? 'priority-low' : '');
            tagsHtml += `<span class="task-tag ${prioClass}">P: ${t.priority}</span>`;
          }
          if (t.dueDate) {
             tagsHtml += `<span class="task-tag">${new Date(t.dueDate).toLocaleDateString()}</span>`;
          }
          
          // --- Helper: Format date for input ---
          const isoDueDate = t.dueDate ? new Date(t.dueDate).toISOString().split('T')[0] : '';
          
          // --- Task Content (Visible part) ---
          li.innerHTML = `
            <div class="task-content">
              <!-- Layout Change: Cleaner structure -->
              <div class="left">
                <div class="task-main-line">
                  <input type="checkbox" ${t.isCompleted ? 'checked' : ''} aria-label="Complete task" />
                  <p>${escapeHtml(t.text)}</p>
                </div>
                <!-- Layout Change: Tags on new line -->
                <div class="task-tags" ${tagsHtml ? '' : 'style="display: none;"'}>
                  ${tagsHtml}
                </div>
              </div>
              <div class="right">
                <button class="icon-btn edit-btn" aria-label="Edit task">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                </button>
                <button class="icon-btn delete-btn" aria-label="Delete task">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                </button>
              </div>
            </div>
            
            <!-- In-place Edit Form (Hidden part) -->
            <form class="task-edit-form">
              <input type="text" class="edit-text full-width" value="${escapeHtml(t.text)}" required />
              <select class="edit-category">
                <option value="General" ${t.category === 'General' ? 'selected' : ''}>General</option>
                <option value="Work" ${t.category === 'Work' ? 'selected' : ''}>Work</option>
                <option value="Study" ${t.category === 'Study' ? 'selected' : ''}>Study</option>
                <option value="Personal" ${t.category === 'Personal' ? 'selected' : ''}>Personal</option>
              </select>
              <input type="date" class="edit-due" value="${isoDueDate}" />
              <input type="number" class="edit-priority" min="1" max="5" placeholder="Priority" value="${t.priority || ''}" />
              <input type="text" class="edit-location" placeholder="Location" value="${escapeHtml(t.location)}" />
              <input type="text" class="edit-notes full-width" placeholder="Notes" value="${escapeHtml(t.notes)}" />
              <input type="text" class="edit-tags full-width" placeholder="Tags (comma separated)" value="${escapeHtml(t.tags)}" />
              <div class="edit-actions">
                <button type="button" class="cancel-edit-btn">Cancel</button>
                <button type="submit" class="save-edit-btn">Save</button>
              </div>
            </form>
          `;
          
          // --- Add Event Listeners ---
          const checkbox = li.querySelector('input[type="checkbox"]');
          const editBtn = li.querySelector('.edit-btn');
          const deleteBtn = li.querySelector('.delete-btn');
          const editForm = li.querySelector('.task-edit-form');
          const cancelBtn = li.querySelector('.cancel-edit-btn');
          
          checkbox.addEventListener('change', () => toggleComplete(t._id, checkbox.checked));
          deleteBtn.addEventListener('click', () => deleteTask(t._id));
          
          // In-place edit logic
          editBtn.addEventListener('click', () => {
            li.classList.add('is-editing');
          });
          
          cancelBtn.addEventListener('click', () => {
            li.classList.remove('is-editing');
            // Form will be reset on next render, or we could reset it manually here
          });
          
          editForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const changes = {
              text: li.querySelector('.edit-text').value,
              category: li.querySelector('.edit-category').value,
              dueDate: li.querySelector('.edit-due').value || undefined,
              priority: li.querySelector('.edit-priority').value || undefined,
              location: li.querySelector('.edit-location').value.trim() || undefined,
              notes: li.querySelector('.edit-notes').value.trim() || undefined,
              tags: li.querySelector('.edit-tags').value.trim() || undefined,
            };
            li.classList.remove('is-editing');
Provider: 
            updateTask(t._id, changes);
          });

          taskList.appendChild(li);
        });
      }

      // ========================================
      // ADD TASK FORM (REDESIGNED)
      // ========================================
      
      // --- Form Expansion Logic ---
      const taskText = document.getElementById('task-text');
      const moreOptionsBtn = document.getElementById('more-options-btn');
      
      taskText.addEventListener('focus', () => {
        taskForm.classList.add('expanded');
      });
      
      moreOptionsBtn.addEventListener('click', () => {
        taskForm.classList.toggle('extra-expanded');
        moreOptionsBtn.textContent = taskForm.classList.contains('extra-expanded') ? 'Fewer Options' : 'More Options';
      });
      
      // --- Form Submit Logic ---
      taskForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const addBtn = document.getElementById('add-task-btn');
        addBtn.disabled = true;
        
        const text = document.getElementById('task-text').value.trim();
        if (!text) {
          addBtn.disabled = false;
          showToast('Task text is required!', 2000);
          return;
        }

        const taskData = {
          text: text,
          category: document.getElementById('task-category').value,
          dueDate: document.getElementById('task-due').value || undefined,
          priority: document.getElementById('task-priority').value || undefined,
          location: document.getElementById('task-location').value.trim() || undefined,
          notes: document.getElementById('task-notes').value.trim() || undefined,
          tags: document.getElementById('task-tags').value.trim() || undefined,
        };

        try {
          const res = await fetch(`${API}/tasks`, { 
            method: 'POST', 
            headers: {'Content-Type':'application/json'}, 
            body: JSON.stringify(taskData) 
          });
          if (!res.ok) {
            const err = await res.json();
            throw new Error(err.error || 'Could not add task');
          }
          showToast('Task added!', 1800);
          fetchTasks(); // Refresh list
          
          // Reset form
          taskForm.reset();
          document.getElementById('task-text').value = ''; // Clear text
          taskForm.classList.remove('expanded', 'extra-expanded');
          moreOptionsBtn.textContent = 'More Options';
          
        } catch (e) {
          showToast('Error: ' + e.message, 3000);
        }
        
        addBtn.disabled = false;
      });

      // ========================================
      // DARK MODE TOGGLE
      // ========================================
      function setDarkIcon() {
        const isDark = document.body.classList.contains('dark-mode');
        darkIcon.innerHTML = isDark
          ? `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path></svg>`
          : `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`;
      }

      darkToggle.addEventListener('click', () => {
        const body = document.body;
        body.classList.toggle('dark-mode');
        const pressed = body.classList.contains('dark-mode');
        darkToggle.setAttribute('aria-pressed', pressed);
        setDarkIcon();
      });
      setDarkIcon();

      // ========================================
      // LOGIN MODAL LOGIC
      // ========================================
      document.getElementById('login-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const loginModal = document.getElementById('login-modal');
        loginModal.classList.remove('modal-fade-in');
        loginModal.classList.add('modal-fade-out');
        
        setTimeout(() => {
          loginModal.style.display = 'none';
          document.getElementById('app-content').style.display = '';
          fetchTasks(); // Initial fetch after "login"
        }, 400);
      });
      
      // Hide app content initially
      document.getElementById('app-content').style.display = 'none';
      
    }); // End DOMContentLoaded
  </script>
</body>
</html>